<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>img {width:100%;}</style>
</head>
<body>
<div id="toolbar">
    <button id="save" disabled="disabled">Overwrite file with test PNG</button>
</div>
<img />
<script>
/*globals btoa */
(function () {'use strict';
    function $ (sel) {
        return document.querySelector(sel);
    }

    var pathID,
        saveMessage = 'webapp-save',
        excludedMessages = [saveMessage],
        img = document.querySelector('img'),
        imageType = 'png';
    
    function setImageWithBinary (bin) {
        img.src = 'data:image/' + imageType + ';base64,' + btoa(bin); // Converts binary string to base64
    }
    document.title = 'WebAppFind ' + imageType.toUpperCase() + ' edit test';

    window.addEventListener('message', function(e) {
        if (e.origin !== window.location.origin || // PRIVACY AND SECURITY! (for viewing and saving, respectively)
            (!Array.isArray(e.data) || excludedMessages.indexOf(e.data[0]) > -1) // Validate format and avoid a post below
        ) {
            return;
        }
        var messageType = e.data[0];
        switch (messageType) {
            case 'webapp-view':
                // Populate the contents
                pathID = e.data[1];
                setImageWithBinary(e.data[2]);
                $('#save').disabled = false;
                break;
            case 'webapp-save-end':
                alert('HARD-CODED TEST save complete for pathID ' + e.data[1] + '!');
                break;
            default:
                throw 'Unexpected method' + messageType;
        }
    }, false);

    $('#save').addEventListener('click', function () {
        if (!pathID) {
            alert('No pathID set by Firefox yet! Remember to invoke this file from an executable or command line and in edit mode.');
            return;
        }
        var redDot = 'PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x05\x00\x00\x00\x05\x08\x06\x00\x00\x00o&å\x00\x00\x00\x1cIDAT\x08×cøÿÿ?Ã\x7f\x06 \x05Ã \x12Ð1ñXÍ\x04\x00\x0eõ5ËÑ\x0e\x1f\x00\x00\x00\x00IEND®B`'; // Courtesy http://en.wikipedia.org/wiki/Data:_URL
        setImageWithBinary(redDot);
        window.postMessage([saveMessage, pathID, redDot], window.location.origin);
    });

}());
</script>
</body>
</html>
