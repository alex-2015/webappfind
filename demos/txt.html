<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>WebAppFind text editor demo</title>
    <!-- WebAppFind -->
    <link href="javascript.css" rel="stylesheet" type="text/css" />
    <script src="register.js"></script>
    <script>
/*
TODOS:
1. We could allow separate tabs when new pathIDs are obtained via our message listener
*/

(function () {'use strict';

var saveMessage = 'webapp-save',
    excludedMessages = [saveMessage];

function $ (sel) {
    return document.querySelector(sel);
}

window.addEventListener('DOMContentLoaded', function () {
    var pathID;
    
    window.addEventListener('message', function(e) {
        if (e.origin !== window.location.origin || // PRIVACY AND SECURITY! (for viewing and saving, respectively)
            (!Array.isArray(e.data) || excludedMessages.indexOf(e.data[0]) > -1) // Validate format and avoid our post below
        ) {
            return;
        }
        var messageType = e.data[0];
        switch (messageType) {
            case 'webapp-view':
                // Populate the contents
                pathID = e.data[1];
                $('#text').value = e.data[2];
                $('#save').disabled = false;
                break;
            case 'webapp-save-end':
                alert('save complete for pathID ' + e.data[1] + '!');
                break;
            default:
                throw 'Unexpected mode';
        }
    }, false);

    $('#save').addEventListener('click', function () {
        if (!pathID) {
            alert('No pathID set by Firefox yet! Remember to invoke this file from an executable or command line and in edit mode.');
            return;
        }
        window.postMessage([saveMessage, pathID, $('#text').value], window.location.origin);
    });
    
/*
    addRegistrationHandlers([{
        type: 'edittxt', info: 'Protocol for viewing local TXT files',
        instructions: 'Register this app as a handler for viewing local TXT files'
    }], 'http://127.0.0.1/webappfind/demos/txt.html?uri=%s');
*/

});

}());
    </script>
</head>
<body>
<div id="actions"></div>
<div id="toolbar">
    <button id="save" disabled="disabled">Save</button>
</div>
<div id="txt-container">
<textarea id="text" cols="100" rows="30" placeholder="Loading..."></textarea>
</div>
</body>
</html>
